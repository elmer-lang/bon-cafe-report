<script>
// 5️⃣ MULTI-LANGUAGE SUPPORT
const langDict = {
  en: {
    login_title: "Login", btn_login: "Login", no_account: "No account?", link_register: "Register here",
    reg_title: "Create Account", btn_register: "Register", have_account: "Have an account?", link_login: "Login here",
    sel_pos: "Select Position", sel_area: "Select Area",
    nav_dash: "Dashboard", nav_visit: "Branch Visit Checklist", nav_team: "Team Leader Status", nav_logout: "Logout",
    dash_intro: "Select an option from the sidebar to begin your reporting.",
    modal_success: "Success", modal_error: "Error", modal_warning: "Warning"
  },
  ar: {
    login_title: "تسجيل الدخول", btn_login: "دخول", no_account: "ليس لديك حساب؟", link_register: "سجل هنا",
    reg_title: "إنشاء حساب", btn_register: "تسجيل", have_account: "لديك حساب؟", link_login: "ادخل هنا",
    sel_pos: "اختر المنصب", sel_area: "اختر المنطقة",
    nav_dash: "لوحة التحكم", nav_visit: "قائمة فحص الفرع", nav_team: "حالة قائد الفريق", nav_logout: "خروج",
    dash_intro: "اختر خيارًا من القائمة الجانبية لبدء التقرير.",
    modal_success: "تم بنجاح", modal_error: "خطأ", modal_warning: "تحذير"
  }
};

let currentLang = 'en';
let currentUser = null;

function toggleLang() {
  currentLang = currentLang === 'en' ? 'ar' : 'en';
  document.getElementById('lang-label').innerText = currentLang.toUpperCase();
  document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  
  const elements = document.querySelectorAll('[data-i18n]');
  elements.forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (langDict[currentLang][key]) {
      el.innerText = langDict[currentLang][key];
    }
  });
}

// 4️⃣ ALERT SYSTEM
function showAlert(type, title, message) {
  const overlay = document.getElementById('modal-overlay');
  const iconDiv = document.getElementById('modal-icon');
  const titleEl = document.getElementById('modal-title');
  const msgEl = document.getElementById('modal-message');
  const btn = document.getElementById('modal-btn');
  
  overlay.classList.remove('hidden');
  
  // Theme based on type
  if (type === 'success') {
    iconDiv.innerHTML = '<i class="fa fa-check-circle" style="color:var(--success)"></i>';
    btn.style.backgroundColor = 'var(--success)';
  } else if (type === 'error') {
    iconDiv.innerHTML = '<i class="fa fa-times-circle" style="color:var(--error)"></i>';
    btn.style.backgroundColor = 'var(--error)';
  } else if (type === 'warning') {
    iconDiv.innerHTML = '<i class="fa fa-exclamation-triangle" style="color:var(--warning)"></i>';
    btn.style.backgroundColor = 'var(--warning)';
  }
  
  titleEl.innerText = title || (currentLang === 'en' ? 'Alert' : 'تنبيه');
  msgEl.innerText = message;
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}

// UI LOGIC
function togglePass(id) {
  const input = document.getElementById(id);
  input.type = input.type === "password" ? "text" : "password";
}

function showRegister() {
  document.getElementById('login-form').classList.add('hidden');
  document.getElementById('register-form').classList.remove('hidden');
  loadDropdowns();
}

function showLogin() {
  document.getElementById('register-form').classList.add('hidden');
  document.getElementById('login-form').classList.remove('hidden');
}

function loadDropdowns() {
  google.script.run.withSuccessHandler(function(data) {
    const posSelect = document.getElementById('reg-position');
    const areaSelect = document.getElementById('reg-area');
    
    // Clear and repopulate
    posSelect.innerHTML = `<option value="" disabled selected>${langDict[currentLang].sel_pos}</option>`;
    areaSelect.innerHTML = `<option value="" disabled selected>${langDict[currentLang].sel_area}</option>`;
    
    data.positions.forEach(p => {
      let opt = document.createElement('option'); opt.value = p; opt.text = p; posSelect.add(opt);
    });
    data.areas.forEach(a => {
      let opt = document.createElement('option'); opt.value = a; opt.text = a; areaSelect.add(opt);
    });
  }).getFormDropdowns();
}

// SIDEBAR TOGGLE
document.getElementById('sidebar-toggle').addEventListener('click', function() {
  const sidebar = document.getElementById('sidebar');
  if (window.innerWidth <= 768) {
    sidebar.classList.toggle('active');
  } else {
    sidebar.classList.toggle('collapsed');
  }
});
document.getElementById('close-sidebar').addEventListener('click', function(){
  document.getElementById('sidebar').classList.remove('active');
});

// 6️⃣ AUTH LOGIC

// REGISTER
function handleRegister() {
  const email = document.getElementById('reg-email').value;
  const id = document.getElementById('reg-id').value;
  const name = document.getElementById('reg-name').value;
  const position = document.getElementById('reg-position').value;
  const area = document.getElementById('reg-area').value;
  const password = document.getElementById('reg-pass').value;

  if (!email || !id || !name || !position || !area || !password) {
    showAlert('warning', langDict[currentLang].modal_warning, 'Please fill all fields');
    return;
  }
  if (id.length !== 4) {
    showAlert('warning', langDict[currentLang].modal_warning, 'ID must be 4 digits');
    return;
  }

  // Loading state (could add spinner here)
  
  google.script.run.withSuccessHandler(function(res) {
    if (res.success) {
      showAlert('success', langDict[currentLang].modal_success, 'Registration Successful! Please Login.');
      showLogin();
    } else {
      showAlert('error', langDict[currentLang].modal_error, res.message);
    }
  }).registerUser({ email, id, name, position, area, password });
}

// LOGIN
function handleLogin() {
  const id = document.getElementById('login-id').value;
  const pass = document.getElementById('login-pass').value;

  if(!id || !pass) {
    showAlert('warning', langDict[currentLang].modal_warning, 'Enter ID and Password');
    return;
  }

  google.script.run.withSuccessHandler(function(res) {
    if (res.success) {
      currentUser = res.user;
      currentUser.id = id; // Store ID for logout
      
      // Setup UI
      document.getElementById('user-name').innerText = res.user.name;
      document.getElementById('user-pos').innerText = res.user.position;
      document.getElementById('user-area').innerText = res.user.area;
      document.getElementById('welcome-msg').innerText = "Hello, " + res.user.name;

      showAlert('success', langDict[currentLang].modal_success, res.message);
      
      // Switch Views
      setTimeout(() => {
        closeModal();
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('dashboard-section').classList.remove('hidden');
      }, 1500);

    } else {
      showAlert('error', langDict[currentLang].modal_error, res.message);
    }
  }).loginUser(id, pass);
}

// LOGOUT
function handleLogout() {
  if (!currentUser) return;
  
  google.script.run.withSuccessHandler(function(res) {
    showAlert('success', 'See you soon!', res.message);
    setTimeout(() => {
      location.reload(); // Refresh to reset state
    }, 2000);
  }).logoutUser(currentUser.id);
}
</script>